<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GB Remote Lite Config Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            padding: 30px;
        }

        .config-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-info {
            background: #17a2b8;
        }

        .connection-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            height: 450px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 2px;
        }

        .log-ok {
            color: #68d391;
        }

        .log-error {
            color: #fc8181;
        }

        .log-progress {
            color: #fbb6ce;
        }

        .log-status {
            color: #90cdf4;
        }

        .log-safety {
            color: #f6ad55;
        }

        .log-sent {
            color: #a0aec0;
        }

        .log-command {
            color: #c6f6d5;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .firmware-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .actions-section {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .download-progress {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.3s ease;
        }

        .firmware-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .warning-message {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .manual-download {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .flashing-active {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ GB Remote Lite Config Tool</h1>
            <p>Configure your ESP32 hand controller via USB serial connection</p>
        </div>

        <div class="main-content">
            <!-- Configuration Panel -->
            <div class="config-panel">
                <div class="section">
                    <h3>üîå Connection</h3>
                    <div id="connectionStatus" class="connection-status disconnected">
                        Not Connected
                    </div>
                    <button id="connectBtn" class="btn">Connect to Remote</button>
                    <button id="disconnectBtn" class="btn btn-secondary" disabled>Disconnect</button>
                </div>

                <div class="section">
                    <h3>‚öôÔ∏è Basic Configuration</h3>

                    <!-- Toggle Controls -->
                    <div class="grid-2" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Throttle Inversion:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="throttleInversion" onchange="toggleThrottleInversion()">
                                <label for="throttleInversion" style="margin: 0;">Inverted</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Level Assistant:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="levelAssistant" onchange="toggleLevelAssistant()">
                                <label for="levelAssistant" style="margin: 0;">Enabled</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Speed Unit:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="radio" name="speedUnit" id="speedKm" value="km" checked onchange="toggleSpeedUnit(this.value)">
                                <label for="speedKm" style="margin: 0;">km/h</label>

                                <input type="radio" name="speedUnit" id="speedMi" value="mi" onchange="toggleSpeedUnit(this.value)">
                                <label for="speedMi" style="margin: 0;">mi/h</label>
                            </div>
                        </div>
                    </div>

                    <!-- Hardware Configuration -->
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="motorPulley">Motor Pulley Teeth:</label>
                            <input type="number" id="motorPulley" value="15" min="1" max="255">
                            <button class="btn" onclick="setMotorPulley()">Set</button>
                        </div>
                        <div class="form-group">
                            <label for="wheelPulley">Wheel Pulley Teeth:</label>
                            <input type="number" id="wheelPulley" value="33" min="1" max="255">
                            <button class="btn" onclick="setWheelPulley()">Set</button>
                        </div>
                        <div class="form-group">
                            <label for="wheelDiameter">Wheel Diameter (mm):</label>
                            <input type="number" id="wheelDiameter" value="115" min="1" max="255">
                            <button class="btn" onclick="setWheelSize()">Set</button>
                        </div>
                        <div class="form-group">
                            <label for="motorPoles">Motor Poles:</label>
                            <input type="number" id="motorPoles" value="14" min="1" max="255">
                            <button class="btn" onclick="setMotorPoles()">Set</button>
                        </div>
                    </div>
                </div>

                <div class="firmware-section">
                    <h3>üì± Firmware Management</h3>
                    <div class="form-group">
                        <label for="firmwareFile">Select Firmware File:</label>
                        <input type="file" id="firmwareFile" accept=".bin" onchange="handleFirmwareFileSelect()">
                    </div>

                    <div class="download-progress" id="downloadProgress">
                        <div>Downloading firmware...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div id="downloadStatus">Preparing download...</div>
                    </div>

                    <div class="firmware-info" id="firmwareInfo">
                        <h4> Firmware Information</h4>
                        <div id="firmwareDetails"></div>
                    </div>

                    <div class="manual-download" id="manualDownload" style="display: none;">
                        <h4> Manual Download Required</h4>
                        <p>Due to browser security restrictions, automatic download is not available. Please download manually:</p>
                        <ol>
                            <li>Click the button below to open GitHub Releases</li>
                            <li>Download the latest .bin file for your ESP32</li>
                            <li>Use the "Select Firmware File" option above to upload it</li>
                        </ol>
                        <button class="btn btn-info" onclick="openGitHubReleases()">Open GitHub Releases</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-info" onclick="downloadLatestFirmware()">Download Latest</button>
                        <button class="btn btn-success" id="flashBtn" onclick="flashFirmware()" disabled>Select Firmware First</button>
                        <button class="btn" onclick="getFirmwareVersion()">Get Version</button>
                        <button class="btn btn-warning" onclick="checkFirmwareUpdate()">Check Updates</button>
                    </div>
                </div>

                <div class="actions-section">
                    <h3>üîß Actions</h3>
                    <div class="grid-2">
                        <button class="btn" onclick="getConfig()">Get Config</button>
                        <button class="btn btn-warning" onclick="resetOdometer()">Reset Odometer</button>
                        <button class="btn btn-success" onclick="calibrateThrottle()">Calibrate Throttle</button>
                        <button class="btn" onclick="getCalibration()">Get Calibration</button>
                    </div>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="section">
                    <h3>üìä Status & Logs</h3>
                    <div id="logArea" class="log-area">
GB Remote Lite Config Tool
Ready to connect...
                    </div>
                </div>

                <div class="section">
                    <h3>‚ÑπÔ∏è Device Info</h3>
                    <div id="deviceInfo">
                        <div><strong>Status:</strong> <span id="deviceStatus">Disconnected</span></div>
                        <div><strong>Firmware:</strong> <span id="firmwareVersion">Unknown</span></div>
                        <div><strong>BLE:</strong> <span id="bleStatus">Unknown</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- esptool-js library -->
    <script src="https://unpkg.com/esptool-js/lib/index.js"></script>

    <script>
        // Global variables
        let serialPort = null;
        let reader = null;
        let writer = null;
        let isConnected = false;

        // ESP32 flashing variables
        let espLoader = null;
        let isFlashing = false;

        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logArea = document.getElementById('logArea');
        const downloadProgress = document.getElementById('downloadProgress');
        const progressFill = document.getElementById('progressFill');
        const downloadStatus = document.getElementById('downloadStatus');
        const firmwareInfo = document.getElementById('firmwareInfo');
        const firmwareDetails = document.getElementById('firmwareDetails');
        const manualDownload = document.getElementById('manualDownload');

        // Check Web Serial API support
        if (!('serial' in navigator)) {
            logMessage('‚ùå Web Serial API not supported in this browser. Please use Chrome or Edge.');
            connectBtn.disabled = true;
        }

        // Terminal interface for esptool-js
        const espLoaderTerminal = {
            clean() {
                // Clear the log area when starting a new operation
                logArea.innerHTML = '';
            },
            writeLine(data) {
                logMessage(data, 'status');
            },
            write(data) {
                // Write data without newline
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry log-status';
                logEntry.textContent = data;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight;
            }
        };

        // Connection functions
        async function connectToESP32() {
            try {
                // Request port access
                serialPort = await navigator.serial.requestPort();

                // Open port with ESP32 settings
                await serialPort.open({
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });

                // Setup reader and writer
                reader = serialPort.readable.getReader();
                writer = serialPort.writable.getWriter();

                // Update UI
                isConnected = true;
                updateConnectionStatus(true);
                logMessage('‚úÖ Connected to ESP32');

                // Start reading data
                readSerialData();

            } catch (error) {
                logMessage('‚ùå Connection failed: ' + error.message);
            }
        }

        async function disconnectFromESP32() {
            try {
                if (reader) {
                    reader.releaseLock();
                }
                if (writer) {
                    writer.releaseLock();
                }
                if (serialPort) {
                    await serialPort.close();
                }

                isConnected = false;
                updateConnectionStatus(false);
                logMessage('üîå Disconnected from ESP32');

            } catch (error) {
                logMessage('‚ùå Disconnect error: ' + error.message);
            }
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'connection-status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                connectionStatus.textContent = 'Not Connected';
                connectionStatus.className = 'connection-status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // Serial communication functions
        async function sendCommand(command) {
            if (!isConnected || !writer) {
                logMessage('‚ùå Not connected to ESP32');
                return false;
            }

            try {
                const data = new TextEncoder().encode(command + '\n');
                await writer.write(data);
                logMessage('  Sent: ' + command, 'sent');
                return true;
            } catch (error) {
                logMessage('‚ùå Send error: ' + error.message, 'error');
                return false;
            }
        }

        async function readSerialData() {
            try {
                while (isConnected && reader) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const text = new TextDecoder().decode(value);
                    const lines = text.split('\n');

                    for (const line of lines) {
                        if (line.trim()) {
                            logMessage(line.trim());
                            parseResponse(line.trim());
                        }
                    }
                }
            } catch (error) {
                if (isConnected) {
                    logMessage('‚ùå Read error: ' + error.message, 'error');
                }
            }
        }

        function parseResponse(response) {
            // Parse configuration responses
            if (response.includes('Motor pulley teeth set to:')) {
                const teeth = parseInt(response.match(/\d+/)[0]);
                document.getElementById('motorPulley').value = teeth;
            }
            if (response.includes('Wheel pulley teeth set to:')) {
                const teeth = parseInt(response.match(/\d+/)[0]);
                document.getElementById('wheelPulley').value = teeth;
            }
            if (response.includes('Wheel diameter set to:')) {
                const diameter = parseInt(response.match(/\d+/)[0]);
                document.getElementById('wheelDiameter').value = diameter;
            }
            if (response.includes('Motor poles set to:')) {
                const poles = parseInt(response.match(/\d+/)[0]);
                document.getElementById('motorPoles').value = poles;
            }
            if (response.includes('PID Kp set to:')) {
                const kp = parseFloat(response.match(/[\d.]+/)[0]);
                document.getElementById('pidKp').value = kp;
            }
            if (response.includes('PID Ki set to:')) {
                const ki = parseFloat(response.match(/[\d.]+/)[0]);
                document.getElementById('pidKi').value = ki;
            }
            if (response.includes('PID Kd set to:')) {
                const kd = parseFloat(response.match(/[\d.]+/)[0]);
                document.getElementById('pidKd').value = kd;
            }
            if (response.includes('PID Output Max set to:')) {
                const outputMax = parseFloat(response.match(/[\d.]+/)[0]);
                document.getElementById('pidOutputMax').value = outputMax;
            }

            // Parse toggle responses
            if (response.includes('Throttle inversion: ENABLED')) {
                document.getElementById('throttleInversion').checked = true;
            } else if (response.includes('Throttle inversion: DISABLED')) {
                document.getElementById('throttleInversion').checked = false;
            }

            if (response.includes('Level assistant: ENABLED')) {
                document.getElementById('levelAssistant').checked = true;
            } else if (response.includes('Level assistant: DISABLED')) {
                document.getElementById('levelAssistant').checked = false;
            }

            if (response.includes('Speed Unit: mi/h')) {
                document.getElementById('speedUnit').checked = true;
            } else if (response.includes('Speed Unit: km/h')) {
                document.getElementById('speedUnit').checked = false;
            }

            // Parse firmware version
            if (response.includes('Firmware version:') || response.includes('Firmware Version:')) {
                try {
                    const versionText = response.split(':')[1].trim();
                    document.getElementById('firmwareVersion').textContent = versionText;
                    logMessage(`[INFO] Firmware version: ${versionText}`, 'status');
                } catch (e) {
                    logMessage('[ERROR] Could not parse firmware version', 'error');
                }
            }
        }

        // Enhanced log message function matching PyQt formatting
        function logMessage(message, type = 'default') {
            const timestamp = new Date().toLocaleTimeString();
            let formattedMessage = '';
            let messageType = type;

            // Format different types of messages exactly like PyQt version
            if (message.startsWith('Sent:')) {
                formattedMessage = `  ${message}`;
                messageType = 'sent';
            } else if (message.includes('set to:')) {
                formattedMessage = `[OK] ${message}`;
                messageType = 'ok';
            } else if (message.includes('Throttle inversion:')) {
                const status = message.includes('ENABLED') ? 'enabled' : 'disabled';
                formattedMessage = `[OK] Throttle inversion: ${status}`;
                messageType = 'ok';
            } else if (message.includes('Level assistant:')) {
                const status = message.includes('ENABLED') ? 'enabled' : 'disabled';
                formattedMessage = `[OK] Level assistant: ${status}`;
                messageType = 'ok';
            } else if (message.includes('Odometer reset')) {
                formattedMessage = `[OK] ${message}`;
                messageType = 'ok';
            } else if (message.includes('Unknown command:')) {
                formattedMessage = `[ERROR] ${message}`;
                messageType = 'error';
            } else if (message.includes('=== Hand Controller Commands ===')) {
                formattedMessage = message;
                messageType = 'default';
            } else if (['invert_throttle', 'level_assistant', 'reset_odometer', 'set_motor_pulley',
                       'set_wheel_pulley', 'set_wheel_size', 'set_motor_poles', 'get_config'].some(cmd => message.includes(cmd))) {
                formattedMessage = `  ${message}`;
                messageType = 'command';
            } else if (message.includes('calibrate_throttle') && message.includes('Manually calibrate throttle range')) {
                formattedMessage = `  ${message}`;
                messageType = 'command';
            } else if (message.includes('get_calibration') && message.includes('Show throttle calibration status')) {
                formattedMessage = `  ${message}`;
                messageType = 'command';
            } else if (message.includes('Calibration progress:')) {
                formattedMessage = `[PROGRESS] ${message}`;
                messageType = 'progress';
            } else if (message.includes('Calibration complete!')) {
                formattedMessage = `[OK] ${message}`;
                messageType = 'ok';
            } else if (message.includes('Calibration failed')) {
                formattedMessage = `[ERROR] ${message}`;
                messageType = 'error';
            } else if (message.includes('Raw range:') || message.includes('Calibrated range:')) {
                formattedMessage = `  ${message}`;
                messageType = 'default';
            } else if (message.includes('Calibration Status:')) {
                formattedMessage = `[STATUS] ${message}`;
                messageType = 'status';
            } else if (message.includes('Current ADC Reading:') || message.includes('Current Mapped Value:')) {
                formattedMessage = `  ${message}`;
                messageType = 'default';
            } else if (message.includes('Throttle signals were set to neutral during calibration')) {
                formattedMessage = `[SAFETY] ${message}`;
                messageType = 'safety';
            } else if (message.includes('Calibrated Min Value:') || message.includes('Calibrated Max Value:') || message.includes('Calibrated Range:')) {
                formattedMessage = `  ${message}`;
                messageType = 'default';
            } else {
                formattedMessage = message;
                messageType = 'default';
            }

            // Create log entry with proper styling
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${messageType}`;
            logEntry.textContent = formattedMessage;

            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Configuration functions - using exact same commands as PyQt version
        function setMotorPulley() {
            const value = document.getElementById('motorPulley').value;
            sendCommand(`set_motor_pulley ${value}`);
        }

        function setWheelPulley() {
            const value = document.getElementById('wheelPulley').value;
            sendCommand(`set_wheel_pulley ${value}`);
        }

        function setWheelSize() {
            const value = document.getElementById('wheelDiameter').value;
            sendCommand(`set_wheel_size ${value}`);
        }

        function setMotorPoles() {
            const value = document.getElementById('motorPoles').value;
            sendCommand(`set_motor_poles ${value}`);
        }

        function setPidKp() {
            const value = document.getElementById('pidKp').value;
            sendCommand(`set_pid_kp ${value}`);
        }

        function setPidKi() {
            const value = document.getElementById('pidKi').value;
            sendCommand(`set_pid_ki ${value}`);
        }

        function setPidKd() {
            const value = document.getElementById('pidKd').value;
            sendCommand(`set_pid_kd ${value}`);
        }

        function setPidOutputMax() {
            const value = document.getElementById('pidOutputMax').value;
            sendCommand(`set_pid_output_max ${value}`);
        }

        function getPidParams() {
            sendCommand('get_pid_params');
        }

        function loadPidDefaults() {
            document.getElementById('pidKp').value = 0.8;
            document.getElementById('pidKi').value = 0.5;
            document.getElementById('pidKd').value = 0.05;
            document.getElementById('pidOutputMax').value = 48.0;
            logMessage('‚úÖ PID defaults loaded');
        }

        function getConfig() {
            sendCommand('get_config');
        }

        function resetOdometer() {
            if (confirm('Are you sure you want to reset the odometer?')) {
                sendCommand('reset_odometer');
            }
        }

        function calibrateThrottle() {
            sendCommand('calibrate_throttle');
        }

        function getCalibration() {
            sendCommand('get_calibration');
        }

        // Toggle functions for basic configuration
        function toggleThrottleInversion() {
            if (!isConnected) {
                logMessage('‚ùå Not connected to ESP32', 'error');
                // Revert checkbox state
                document.getElementById('throttleInversion').checked = !document.getElementById('throttleInversion').checked;
                return;
            }
            sendCommand('invert_throttle');
        }

        function toggleLevelAssistant() {
            if (!isConnected) {
                logMessage('‚ùå Not connected to ESP32', 'error');
                // Revert checkbox state
                document.getElementById('levelAssistant').checked = !document.getElementById('levelAssistant').checked;
                return;
            }
            sendCommand('level_assistant');
        }

        function toggleSpeedUnit(unit) {
            const kmCheckbox = document.getElementById('speedKm');
            const miCheckbox = document.getElementById('speedMi');

            if (!isConnected) {
                logMessage('‚ùå Not connected to ESP32', 'error');
                return;
            }

            if (unit === 'km') {
                kmCheckbox.checked = true;  // always checked when clicked
                miCheckbox.checked = false; // uncheck the other
                sendCommand('toggle_speed_unit');
            } else if (unit === 'mi') {
                kmCheckbox.checked = false;
                miCheckbox.checked = true;
                sendCommand('toggle_speed_unit');
            }
        }

        function getFirmwareVersion() {
            sendCommand('get_firmware_version');
        }

        // Simplified firmware download - just show manual option
        function downloadLatestFirmware() {
            logMessage('[INFO] Opening GitHub Releases for manual download...', 'status');
            manualDownload.style.display = 'block';
            openGitHubReleases();
        }

        function openGitHubReleases() {
            window.open('https://github.com/georgebenett/gb_remote/releases/latest', '_blank');
            logMessage('[INFO] GitHub Releases opened in new tab', 'status');
        }

        async function checkFirmwareUpdate() {
            try {
                logMessage('[INFO] Checking for firmware updates...', 'status');

                // Get current firmware version from device
                if (isConnected) {
                    sendCommand('get_firmware_version');
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait for response
                }

                const currentVersion = document.getElementById('firmwareVersion').textContent;

                logMessage(`[INFO] Current version: ${currentVersion}`, 'status');
                logMessage('[INFO] To check for updates, visit GitHub Releases:', 'status');
                logMessage('[INFO] https://github.com/georgebenett/gb_remote/releases/latest', 'status');

                if (currentVersion === 'Unknown') {
                    logMessage('[WARNING] Could not determine current firmware version', 'warning');
                    logMessage('[INFO] Connect to your device and click "Get Version" first', 'status');
                } else {
                    logMessage('[INFO] Click "Download Latest" to open GitHub Releases', 'status');
                }

            } catch (error) {
                logMessage(`[ERROR] Update check failed: ${error.message}`, 'error');
            }
        }

        async function flashFirmware() {
            const fileInput = document.getElementById('firmwareFile');
            const file = fileInput.files[0];

            if (!file) {
                logMessage('‚ùå Please select a firmware file', 'error');
                return;
            }

            if (isFlashing) {
                logMessage('‚ùå Flashing already in progress', 'error');
                return;
            }

            // Confirm flashing
            if (!confirm(`Are you sure you want to flash firmware to ESP32?\n\nFile: ${file.name}\nSize: ${(file.size / 1024).toFixed(1)} KB\n\nWARNING: This will overwrite the current firmware!`)) {
                return;
            }

            try {
                isFlashing = true;
                const flashBtn = document.getElementById('flashBtn');
                flashBtn.disabled = true;
                flashBtn.textContent = 'Flashing...';
                flashBtn.className = 'btn btn-warning';

                logMessage('üöÄ Starting firmware flashing process...', 'progress');

                // Disconnect from current serial connection if connected
                if (isConnected) {
                    logMessage('üì° Disconnecting from current serial connection...', 'status');
                    await disconnectFromESP32();
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait for port to be released
                }

                // Request port access for flashing
                logMessage('üîå Requesting port access for flashing...', 'status');
                const port = await navigator.serial.requestPort();

                // Open port for flashing
                await port.open({
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });

                logMessage('‚úÖ Port opened for flashing', 'ok');

                // Initialize ESPLoader
                logMessage('üîß Initializing ESP32 loader...', 'status');
                espLoader = new ESPLoader(port, 115200, espLoaderTerminal);

                // Connect to ESP32
                logMessage('üîó Connecting to ESP32...', 'status');
                const chip = await espLoader.main();

                if (!chip) {
                    throw new Error('Failed to connect to ESP32');
                }

                logMessage(`‚úÖ Connected to ${chip.CHIP_NAME} (${chip.CHIP_NAME})`, 'ok');
                logMessage(`üìä Flash size: ${chip.FLASH_SIZES[chip.FLASH_SIZE] || 'Unknown'}`, 'status');
                logMessage(`üîß Flash mode: ${chip.FLASH_MODES[chip.FLASH_MODE] || 'Unknown'}`, 'status');

                // Read firmware file
                logMessage('üìÅ Reading firmware file...', 'status');
                const firmwareData = await readFileAsArrayBuffer(file);

                // Determine flash offset (0x10000 for ESP32 application firmware)
                const flashOffset = 0x10000;
                logMessage(`üìç Flash offset: 0x${flashOffset.toString(16).toUpperCase()}`, 'status');

                // Erase flash
                logMessage('üóëÔ∏è Erasing flash memory...', 'status');
                await espLoader.erase_flash();
                logMessage('‚úÖ Flash erased successfully', 'ok');

                // Write firmware
                logMessage('üìù Writing firmware to flash...', 'status');
                const writeResult = await espLoader.write_flash(flashOffset, firmwareData, true, true);

                if (writeResult) {
                    logMessage('‚úÖ Firmware written successfully', 'ok');
                } else {
                    throw new Error('Failed to write firmware');
                }

                // Verify firmware
                logMessage('üîç Verifying firmware...', 'status');
                const verifyResult = await espLoader.verify_flash(flashOffset, firmwareData);

                if (verifyResult) {
                    logMessage('‚úÖ Firmware verification successful', 'ok');
                } else {
                    logMessage('‚ö†Ô∏è Firmware verification failed, but flashing may have succeeded', 'warning');
                }

                // Reset ESP32
                logMessage('üîÑ Resetting ESP32...', 'status');
                await espLoader.hard_reset();

                // Close port
                await port.close();

                logMessage('üéâ Firmware flashing completed successfully!', 'ok');
                logMessage('üì± ESP32 is now running the new firmware', 'status');
                logMessage('üí° Click "Connect to Remote" to reconnect and verify the new firmware', 'status');

            } catch (error) {
                logMessage(`‚ùå Flashing failed: ${error.message}`, 'error');
                console.error('Flashing error:', error);

                // Try to close port if open
                try {
                    if (port && port.readable) {
                        await port.close();
                    }
                } catch (closeError) {
                    console.error('Error closing port:', closeError);
                }
            } finally {
                isFlashing = false;
                const flashBtn = document.getElementById('flashBtn');
                const fileInput = document.getElementById('firmwareFile');

                if (fileInput.files[0]) {
                    flashBtn.disabled = false;
                    flashBtn.textContent = 'Flash Firmware';
                    flashBtn.className = 'btn btn-success';
                } else {
                    flashBtn.disabled = true;
                    flashBtn.textContent = 'Select Firmware First';
                    flashBtn.className = 'btn btn-success';
                }
            }
        }

        // Helper function to read file as ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Handle firmware file selection
        function handleFirmwareFileSelect() {
            const fileInput = document.getElementById('firmwareFile');
            const file = fileInput.files[0];
            const firmwareInfo = document.getElementById('firmwareInfo');
            const firmwareDetails = document.getElementById('firmwareDetails');
            const flashBtn = document.querySelector('button[onclick="flashFirmware()"]');

            if (file) {
                // Validate file type
                if (!file.name.toLowerCase().endsWith('.bin')) {
                    logMessage('‚ùå Please select a .bin firmware file', 'error');
                    fileInput.value = '';
                    return;
                }

                // Validate file size (reasonable limits for ESP32 firmware)
                const maxSize = 4 * 1024 * 1024; // 4MB
                if (file.size > maxSize) {
                    logMessage('‚ùå Firmware file is too large (max 4MB)', 'error');
                    fileInput.value = '';
                    return;
                }

                // Display file information
                const fileSizeKB = (file.size / 1024).toFixed(1);
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const sizeText = file.size > 1024 * 1024 ? `${fileSizeMB} MB` : `${fileSizeKB} KB`;

                firmwareDetails.innerHTML = `
                    <div><strong>File:</strong> ${file.name}</div>
                    <div><strong>Size:</strong> ${sizeText}</div>
                    <div><strong>Type:</strong> ESP32 Firmware Binary</div>
                    <div><strong>Status:</strong> Ready to flash</div>
                `;

                firmwareInfo.style.display = 'block';
                flashBtn.disabled = false;
                flashBtn.textContent = 'Flash Firmware';

                logMessage(`üìÅ Firmware file selected: ${file.name} (${sizeText})`, 'ok');
            } else {
                firmwareInfo.style.display = 'none';
                flashBtn.disabled = true;
                flashBtn.textContent = 'Select Firmware First';
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connectToESP32);
        disconnectBtn.addEventListener('click', disconnectFromESP32);

        // Initialize
        logMessage('üåê GB Remote Lite Config Tool loaded');
        logMessage(' Connect your ESP32 via USB and click "Connect to Remote"');
        logMessage('üí° For firmware downloads, use the "Download Latest" button to open GitHub Releases');
    </script>
</body>
</html>